# Multi-Noise 바이옴 시스템

> Minecraft 1.18+에서 도입된 Multi-Noise 바이옴 시스템의 이론과 설계 원리를 설명합니다.

## 목차

- [기존 임계값 방식의 한계](#기존-임계값-방식의-한계)
- [Multi-Noise 바이옴 시스템](#multi-noise-바이옴-시스템)
- [6개 노이즈 파라미터](#6개-노이즈-파라미터)
- [최근접 이웃 바이옴 선택](#최근접-이웃-바이옴-선택)
- [지형 형태와 바이옴의 분리](#지형-형태와-바이옴의-분리)
- [단계적 확장 전략](#단계적-확장-전략)
- [설계 고려사항](#설계-고려사항)
- [참고 자료](#참고-자료)

---

## 기존 임계값 방식의 한계

단순 임계값(if/else) 기반 바이옴 선택은 구현이 쉽지만, 근본적인 한계가 있습니다.

### 높이-바이옴 커플링

바이옴을 지표 높이로 결정하면(예: "높이 90 이상이면 산악"), 바이옴이 높이 맵에 강하게 결합됩니다. 이로 인해 다음이 불가능해집니다:

- 높은 고도의 평평한 메사 바이옴
- 낮은 고도의 산악 스타일 블록이 있는 언덕
- 같은 높이대에서 다양한 바이옴 배치

### 경직된 임계값 경계

`temperature < 0.3 → TUNDRA`와 같은 고정 임계값은:

- 급격하고 부자연스러운 바이옴 경계를 만들고
- 조건 검사 순서에 따라 바이옴 우선순위가 달라지며 (순서 아티팩트)
- 블렌딩이나 점진적 전환이 불가능합니다

### 확장성 부족

if/else 체인에 새 바이옴을 추가하려면 기존 임계값을 전부 재조정해야 합니다. 변형 바이옴(예: 꽃 숲, 자작나무 숲)이나 하위 카테고리 도입도 어렵습니다.

---

## Multi-Noise 바이옴 시스템

Minecraft 1.18에서 도입된 **Multi-Noise** 시스템은 지형 형태와 바이옴 정체성을 분리합니다. 바이옴은 N차원 파라미터 공간에서 **최근접 이웃(nearest-neighbor)**을 찾아 선택됩니다.

핵심 아이디어:

1. 각 월드 좌표에서 여러 독립적인 노이즈 값을 샘플링하여 **파라미터 벡터**를 만든다
2. 각 바이옴은 이상적인 파라미터 값(중심점)을 가진다
3. 현재 위치의 파라미터 벡터에 **가장 가까운** 바이옴이 선택된다

이 방식은 if/else 체인 없이 바이옴 테이블에 항목만 추가하면 새로운 바이옴을 도입할 수 있습니다.

---

## 6개 노이즈 파라미터

각 파라미터는 독립적인 노이즈 함수로 생성되며, `[-1.0, 1.0]` 범위의 값을 가집니다.

| 파라미터 | 용도 | 월드에 미치는 영향 |
|---------|------|-----------------|
| **Temperature** | 기후 온도 | 더운 바이옴(사막, 배드랜드) vs 추운 바이옴(눈 덮인 타이가, 얼어붙은 봉우리) |
| **Humidity** | 습도 수준 | 습한 바이옴(정글, 늪) vs 건조한 바이옴(사막, 사바나) |
| **Continentalness** | 육지 vs 바다 | 낮음 = 바다/해안, 중간 = 내륙, 높음 = 깊은 내륙(높은 기본 고도) |
| **Erosion** | 지형 거칠기 | 낮음 = 산악/봉우리, 높음 = 평탄/매끄러운 지형 |
| **Weirdness** | 변형 선택 | 바이옴 변형 결정 (예: 평원 vs 해바라기 평원); PV 변환을 통해 봉우리/골짜기 결정 |
| **Depth** | 지표 vs 지하 | 0 = 지표, 양수 = 지하 (동굴 바이옴 선택) |

이 6개를 역할별로 묶으면:

- **기후 축**: Temperature, Humidity — "이 지역의 기후는?"
- **지형 축**: Continentalness, Erosion — "이 지역의 지형 형태는?"
- **변형 축**: Weirdness — "같은 기후/지형이라도 어떤 변형을?"
- **수직 축**: Depth — "지표인가, 지하인가?"

---

## 최근접 이웃 바이옴 선택

### 원리

```
1. 각 블록 위치 (x, z)에 대해 N개 노이즈 파라미터를 샘플링:
     P = (T, H, C, E, W, D)

2. 각 바이옴 B는 이상적 파라미터 중심점을 정의:
     B_ideal = (T_b, H_b, C_b, E_b, W_b, D_b)

3. 유클리드 거리가 최소인 바이옴을 선택:
     distance(P, B) = (T - T_b)² + (H - H_b)² + (C - C_b)²
                     + (E - E_b)² + (W - W_b)² + (D - D_b)²

4. 가장 가까운 바이옴이 선택됨
```

이 방식의 장점:
- **우선순위 순서가 없음** — if/else 순서에 의한 아티팩트 제거
- **확장이 용이** — 새 바이옴은 파라미터 테이블에 항목만 추가
- **자연스러운 보로노이 분할** — 파라미터 공간이 자연스럽게 분할됨 (아래 설명)

### 보로노이 분할 (Voronoi Tessellation)

최근접 이웃 선택은 파라미터 공간을 **보로노이 다이어그램**으로 분할합니다. 보로노이란, 평면 위에 여러 "씨앗 점(seed)"을 놓았을 때 각 씨앗에 가장 가까운 영역을 나누는 분할 방식입니다.

바이옴 시스템에서는:
- 각 바이옴의 이상적 파라미터 값이 **씨앗 점**
- 파라미터 공간의 모든 점은 가장 가까운 씨앗(바이옴)에 속함
- 인접한 바이옴 영역의 경계는 두 씨앗의 **수직 이등분면**

2D에서는 셀 경계가 선분이고, 6D 파라미터 공간에서는 초평면(hyperplane)이 됩니다. 핵심은 어떤 위치든 정확히 하나의 바이옴에 속하며, 경계가 기하학적으로 자연스럽다는 것입니다.

### 바이옴 파라미터 테이블 예시

```
바이옴           | Temp   | Humidity | Continental | Erosion | Weirdness
----------------|--------|----------|-------------|---------|----------
Plains          |  0.0   |  0.0     |   0.3       |  0.5    |  0.0
Forest          |  0.0   |  0.5     |   0.3       |  0.5    |  0.0
Desert          |  0.8   | -0.5     |   0.3       |  0.5    |  0.0
Snowy Plains    | -0.8   |  0.0     |   0.3       |  0.5    |  0.0
Jungle          |  0.8   |  0.8     |   0.3       |  0.3    |  0.0
Frozen Peaks    | -0.8   |  0.0     |   0.8       | -0.8    |  0.8
Stony Peaks     |  0.5   |  0.0     |   0.8       | -0.8    |  0.8
Ocean           |  0.0   |  0.0     |  -0.8       |  0.5    |  0.0
Deep Ocean      |  0.0   |  0.0     |  -1.0       |  0.5    |  0.0
```

실제 Minecraft는 바이옴당 하나의 중심점이 아닌 **다중 포인트 정의**를 사용하여 더 복잡한 형태의 바이옴 영역을 만듭니다. 하나의 바이옴이 파라미터 공간에서 여러 중심점을 가지면, 비볼록(non-convex)한 영역도 표현할 수 있습니다.

---

## 지형 형태와 바이옴의 분리

Multi-Noise 시스템의 핵심 설계 원칙은 **지형 높이 결정**과 **바이옴 선택**을 분리하는 것입니다.

### 지형 높이 결정

지형 높이는 주로 3개 파라미터의 조합으로 결정됩니다:

- **Continentalness** → 기본 고도 (바다에서 내륙 고원까지)
- **Erosion** → 거칠기 조절 (매끄러운 평원에서 거친 산악까지)
- **PV (Peaks & Valleys)** → 봉우리와 골짜기 추가

이 세 값을 **스플라인(spline)**으로 결합하여 최종 높이를 구합니다.

#### 스플라인이란?

스플라인은 여러 제어점을 부드럽게 연결하는 곡선입니다. 단순 선형 보간(`lerp`)은 두 값 사이를 직선으로 잇지만, 스플라인은 여러 구간을 **부드러운 곡선**으로 연결합니다.

```
선형 보간:  A──────B──────C     (꺾이는 점이 생김)
스플라인:   A~~~~~~B~~~~~~C     (전체가 매끄러운 곡선)
```

지형 생성에서 스플라인을 쓰는 이유는, Continentalness 값에 따른 높이 전환이 자연스러워야 하기 때문입니다. 예를 들어:

```
Continentalness → 높이 매핑 (구간별 스플라인):
  0.0~0.3 (바다)   → 30~48  (해저에서 얕은 바다로)
  0.3~0.45 (해안)  → 48~52  (좁은 해안 전환)
  0.45~0.7 (내륙)  → 52~65  (평원/저지대)
  0.7~0.85 (구릉)  → 65~80  (언덕)
  0.85~1.0 (산악)  → 80~100 (산)
```

단순한 구현에서는 이런 구간별 선형 함수(piecewise linear)로 충분하며, 더 자연스러운 결과를 위해 3차 스플라인(cubic spline)을 사용할 수도 있습니다.

#### PV (Peaks & Valleys) 변환

Weirdness 노이즈를 봉우리/골짜기 형태로 변환하는 함수입니다:

```
PV = 1 - |3 * |Weirdness| - 2|
```

이 변환이 하는 일:

```
Weirdness 입력 [-1, 1]:
  -1.0          → PV = 0.0  (골짜기)
  -0.67         → PV = 1.0  (봉우리)
  -0.33         → PV = 0.0  (골짜기)
   0.0          → PV = 1.0  (봉우리)
   0.33         → PV = 0.0  (골짜기)
   0.67         → PV = 1.0  (봉우리)
   1.0          → PV = 0.0  (골짜기)
```

즉, Weirdness의 단조로운 노이즈 패턴을 **주기적인 산-골 패턴**으로 변환합니다. 이로 인해 산맥 사이에 골짜기가, 골짜기 사이에 봉우리가 자연스럽게 교차합니다.

### 바이옴 선택

바이옴은 6개 파라미터 **모두**를 기반으로 독립적으로 선택됩니다. 이는 동일한 지형 형태가 다른 바이옴을 가질 수 있음을 의미합니다.

예: 높은 Erosion(평탄한 지형)인 지역이 Temperature/Humidity에 따라 사막이 될 수도, 평원이 될 수도 있습니다.

---

## 단계적 확장 전략

6개 파라미터를 한번에 구현할 필요는 없습니다. 단계적으로 파라미터를 늘려가는 것이 효과적입니다.

### 3-파라미터 (Temperature, Humidity, Continentalness)

가장 단순한 시작점입니다. Temperature와 Humidity로 기후 바이옴을 구분하고, Continentalness로 육지/바다를 결정합니다. 이것만으로 바이옴 다양성의 약 80%를 커버할 수 있습니다.

### 4-5 파라미터 (+ Erosion, Weirdness)

Erosion을 추가하면 지형 거칠기를 독립적으로 제어할 수 있고, Weirdness를 추가하면 바이옴 변형(예: 평원 vs 해바라기 평원)과 PV(Peaks & Valleys) 기반 봉우리/골짜기 표현이 가능해집니다.

### 6 파라미터 (+ Depth)

Depth 파라미터를 추가하면 지하 동굴 바이옴과 수직 바이옴 변화를 구현할 수 있습니다.

---

## 설계 고려사항

### 바이옴 경계 블렌딩

최근접 이웃 방식은 보로노이 셀 경계에서 급격한 전환을 만듭니다. 완화 방법:

- **블렌딩 없음** — 가장 단순하며 블록 기반 게임에서는 충분히 자연스럽습니다
- **표면 블록 블렌딩** — 경계 부근에서 표면 블록을 혼합 (예: 잔디 → 흙 → 모래)
- **노이즈 기반 흔들림 (jittering)** — 바이옴 판정 좌표에 소규모 노이즈 오프셋을 추가합니다. 이렇게 하면 직선적인 보로노이 경계가 불규칙한 곡선으로 변하여 자연스러운 가장자리가 됩니다

### 노이즈 스케일 선택

| 파라미터 | 권장 스케일 | 이유 |
|---------|-----------|------|
| Temperature | 400-600 | 대규모 기후 구역 |
| Humidity | 300-500 | 지역별 습도 패턴 |
| Continentalness | 500-800 | 매우 큰 대륙 형태 |
| Erosion | 200-400 | 중간 규모 지형 거칠기 |
| Weirdness | 150-300 | 국지적 변화 |

바이옴 노이즈 스케일이 너무 작으면 바이옴이 모자이크처럼 잘게 나뉘고, 너무 크면 월드 전체가 단조로워집니다.

### 성능

추가 노이즈 파라미터마다 청크 컬럼당 FBM 샘플링이 하나 더 필요합니다. 청크가 16x16 컬럼이고 4 옥타브 기준:

- 3 파라미터: 청크당 ~768 노이즈 평가
- 5 파라미터: 청크당 ~1,280 노이즈 평가
- 6 파라미터: 청크당 ~1,536 노이즈 평가

Simplex 노이즈는 O(N^2) 복잡도로 매우 빠르므로, 파라미터 수 증가가 병목이 되지는 않습니다.

---

## 참고 자료

### Multi-Noise 바이옴 시스템
- [Minecraft Wiki — Multi-noise biome source](https://minecraft.wiki/w/Multi-noise_biome_source) — 6개 파라미터 정의와 바이옴 매핑 공식 문서
- [Minecraft Wiki — World generation: Terrain](https://minecraft.wiki/w/World_generation#Terrain) — 밀도 함수, 스플라인, 지형 형성 과정
- [Alan Zucconi — Minecraft 1.18 terrain generation](https://www.alanzucconi.com/2022/06/05/minecraft-world-generation/) — Multi-noise 시스템의 시각적 해설과 파라미터 공간 시각화
- [Henrik Kniberg — Minecraft 1.18 terrain generation (YouTube)](https://www.youtube.com/watch?v=ob3VwY4JyzE) — Mojang 개발자의 새 지형 시스템 발표 영상

### 보로노이 분할
- [Wikipedia — Voronoi diagram](https://en.wikipedia.org/wiki/Voronoi_diagram) — 보로노이 다이어그램의 정의와 속성
- [Red Blob Games — Voronoi Diagrams](https://www.redblobgames.com/x/2022-voronoi-maps-tutorial/) — 게임 개발 맥락의 보로노이 시각적 튜토리얼

### 스플라인과 보간
- [Wikipedia — Spline interpolation](https://en.wikipedia.org/wiki/Spline_interpolation) — 스플라인 보간의 수학적 기초
- [Cubic interpolation (Catmull-Rom)](https://en.wikipedia.org/wiki/Centripetal_Catmull%E2%80%93Rom_spline) — 게임/그래픽스에서 자주 쓰이는 3차 스플라인

### Simplex / Perlin Noise
- [Stefan Gustavson — Simplex noise demystified (PDF)](https://weber.itn.liu.se/~stegu/simplexnoise/simplexnoise.pdf) — Simplex noise 알고리즘 원본 논문
